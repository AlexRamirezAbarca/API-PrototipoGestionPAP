@model WEB_APP_PrototipoGestionPAP.Models.ViewModels.CatalogViewModel<WEB_APP_PrototipoGestionPAP.Models.Actividades>
@inject IConfiguration Configuration

<div class="modal fade" id="agregarModal" tabindex="-1" aria-labelledby="agregarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="formAgregar" asp-action="Agregar" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="agregarModalLabel">Add Activity</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Hidden Fields -->
                        <input type="hidden" id="planificacionId" name="PlanificacionId" />
                        <input type="hidden" id="actividadId" name="ActividadId" />

                        <!-- Select Fields -->
                        <div class="col-md-6">
                            <label for="txtUnidadRespId" class="form-label">Unidad Resp. ID</label>
                            <select class="form-select" id="txtUnidadRespId" name="UnidadRespId" required>
                                <option value="">Select Unidad Resp.</option>
                                <!-- Options to be populated via JS -->
                            </select>
                            <div class="invalid-feedback">Please select a Unidad Resp.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtObjEstrId" class="form-label">Obj. Estratégico ID</label>
                            <select class="form-select" id="txtObjEstrId" name="ObjEstrId" required>
                                <option value="">Select Obj. Estratégico</option>
                                <!-- Options to be populated via JS -->
                            </select>
                            <div class="invalid-feedback">Please select an Obj. Estratégico.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtUnidadEjecutoraId" class="form-label">Unidad Ejecutora ID</label>
                            <select class="form-select" id="txtUnidadEjecutoraId" name="UnidadEjecutoraId">
                                <option value="">Select Unidad Ejecutora</option>
                                <!-- Options to be populated via JS -->
                            </select>
                            <div class="invalid-feedback">Please select a Unidad Ejecutora.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtObjetivoOperativoId" class="form-label">Objetivo Operativo ID</label>
                            <select class="form-select" id="txtObjetivoOperativoId" name="ObjetivoOperativoId">
                                <option value="">Select Objetivo Operativo</option>
                                <!-- Options to be populated via JS -->
                            </select>
                            <div class="invalid-feedback">Please select an Objetivo Operativo.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtEjePnId" class="form-label">Eje PN ID</label>
                            <select class="form-select" id="txtEjePnId" name="EjePnId">
                                <option value="">Select Eje PN</option>
                                <!-- Options to be populated via JS -->
                            </select>
                            <div class="invalid-feedback">Please select an Eje PN.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtObjPnId" class="form-label">Obj PN ID</label>
                            <select class="form-select" id="txtObjPnId" name="ObjPnId">
                                <option value="">Select Obj PN</option>
                                <!-- Options to be populated via JS -->
                            </select>
                            <div class="invalid-feedback">Please select an Obj PN.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtPoliticaPnId" class="form-label">Política PN ID</label>
                            <select class="form-select" id="txtPoliticaPnId" name="PoliticaPnId">
                                <option value="">Select Política PN</option>
                                <!-- Options to be populated via JS -->
                            </select>
                            <div class="invalid-feedback">Please select a Política PN.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtMetaPnId" class="form-label">Meta PN ID</label>
                            <select class="form-select" id="txtMetaPnId" name="MetaPnId">
                                <option value="">Select Meta PN</option>
                                <!-- Options to be populated via JS -->
                            </select>
                            <div class="invalid-feedback">Please select a Meta PN.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtProgramaNacId" class="form-label">Programa Nacional ID</label>
                            <select class="form-select" id="txtProgramaNacId" name="ProgramaNacId">
                                <option value="">Select Programa Nacional</option>
                                <!-- Options to be populated via JS -->
                            </select>
                            <div class="invalid-feedback">Please select a Programa Nacional.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtProgramaInstId" class="form-label">Programa Institucional ID</label>
                            <select class="form-select" id="txtProgramaInstId" name="ProgramaInstId">
                                <option value="">Select Programa Institucional</option>
                                <!-- Options to be populated via JS -->
                            </select>
                            <div class="invalid-feedback">Please select a Programa Institucional.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtProductoInstId" class="form-label">Producto Institucional ID</label>
                            <select class="form-select" id="txtProductoInstId" name="ProductoInstId">
                                <option value="">Select Producto Institucional</option>
                                <!-- Options to be populated via JS -->
                            </select>
                            <div class="invalid-feedback">Please select a Producto Institucional.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtProgramaPreId" class="form-label">Programa Presupuestario ID</label>
                            <select class="form-select" id="txtProgramaPreId" name="ProgramaPreId">
                                <option value="">Select Programa Presupuestario</option>
                                <!-- Options to be populated via JS -->
                            </select>
                            <div class="invalid-feedback">Please select a Programa Presupuestario.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtAccionId" class="form-label">Acción ID</label>
                            <select class="form-select" id="txtAccionId" name="AccionId">
                                <option value="">Select Acción</option>
                                <!-- Options to be populated via JS -->
                            </select>
                            <div class="invalid-feedback">Please select an Acción.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtIndicadorId" class="form-label">Indicador ID</label>
                            <select class="form-select" id="txtIndicadorId" name="IndicadorId">
                                <option value="">Select Indicador</option>
                                <!-- Options to be populated via JS -->
                            </select>
                            <div class="invalid-feedback">Please select an Indicador.</div>
                        </div>

                        <!-- Non-ID Fields -->
                        <div class="col-12">
                            <label for="txtDescripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="txtDescripcion" name="Descripcion" rows="3" required></textarea>
                            <div class="invalid-feedback">Required.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtItemPresupuestario" class="form-label">Item Presupuestario</label>
                            <input type="text" class="form-control" id="txtItemPresupuestario" name="ItemPresupuestario" />
                        </div>
                        <div class="col-md-6">
                            <label for="txtImpacto" class="form-label">Impacto</label>
                            <input type="text" class="form-control" id="txtImpacto" name="Impacto" />
                        </div>
                        <div class="col-md-6">
                            <label for="txtRiesgo" class="form-label">Riesgo</label>
                            <input type="text" class="form-control" id="txtRiesgo" name="Riesgo" />
                        </div>
                        <div class="col-md-6">
                            <label for="txtFuente1Monto" class="form-label">Fuente 1 Monto</label>
                            <input type="number" step="0.01" class="form-control" id="txtFuente1Monto" name="Fuente1Monto" required />
                            <div class="invalid-feedback">Required.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtFuente2Monto" class="form-label">Fuente 2 Monto</label>
                            <input type="number" step="0.01" class="form-control" id="txtFuente2Monto" name="Fuente2Monto" required />
                            <div class="invalid-feedback">Required.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtFuente3Monto" class="form-label">Fuente 3 Monto</label>
                            <input type="number" step="0.01" class="form-control" id="txtFuente3Monto" name="Fuente3Monto" required />
                            <div class="invalid-feedback">Required.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtRecursosActividad" class="form-label">Recursos Actividad</label>
                            <input type="number" step="0.01" class="form-control" id="txtRecursosActividad" name="RecursosActividad" required />
                            <div class="invalid-feedback">Required.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="txtRecursosRestantes" class="form-label">Recursos Restantes</label>
                            <input type="number" step="0.01" class="form-control" id="txtRecursosRestantes" name="RecursosRestantes" required />
                            <div class="invalid-feedback">Required.</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="btnGuardarAgregar" disabled>Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var baseUrl = '@Configuration["ApiSettings:BaseUrl"]';

        function loadSelectData(url, selectId, defaultOptionText) {
            return fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("HTTP error " + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    const selectElement = document.getElementById(selectId);
                    if (selectElement) {
                        selectElement.innerHTML = "";
                        const defaultOption = document.createElement("option");
                        defaultOption.value = "";
                        defaultOption.text = defaultOptionText;
                        selectElement.add(defaultOption);
                        if (data && data.datos) {
                            const selectName = selectElement.getAttribute("name");

                            data.datos.data.forEach(item => {
                                const option = document.createElement("option");
                                option.value = item[selectName] || "";
                                option.text = item.nombre;
                                selectElement.add(option);
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error("Error loading data for " + selectId + ":", error);
                    return Promise.resolve();
                });
        }

        const agregarModal = document.getElementById('agregarModal');
        agregarModal.addEventListener('show.bs.modal', function () {
            const formAgregar = document.getElementById('formAgregar');
            formAgregar.style.display = 'none';
            Promise.all([
                loadSelectData(baseUrl + '/api/UnidadesResponsables', 'txtUnidadRespId', 'Select Unidad Resp.'),
                loadSelectData(baseUrl + '/api/ObjetivosEstrategicosInstitucionales', 'txtObjEstrId', 'Select Obj. Estratégico'),
                loadSelectData(baseUrl + '/api/UnidadesEjecutoras', 'txtUnidadEjecutoraId', 'Select Unidad Ejecutora'),
                loadSelectData(baseUrl + '/api/ObjetivosOperativos', 'txtObjetivoOperativoId', 'Select Objetivo Operativo'),
                loadSelectData(baseUrl + '/api/EjesPlanNacionalDesarrollo', 'txtEjePnId', 'Select Eje PN'),
                loadSelectData(baseUrl + '/api/ObjetivosPlanNacionalDesarrollo', 'txtObjPnId', 'Select Obj PN'),
                loadSelectData(baseUrl + '/api/PoliticasPlanNacionalDesarrollo', 'txtPoliticaPnId', 'Select Política PN'),
                loadSelectData(baseUrl + '/api/MetasPlanNacionalDesarrollo', 'txtMetaPnId', 'Select Meta PN'),
                loadSelectData(baseUrl + '/api/ProgramasNacionales', 'txtProgramaNacId', 'Select Programa Nacional'),
                loadSelectData(baseUrl + '/api/ProgramasInstitucionales', 'txtProgramaInstId', 'Select Programa Institucional'),
                loadSelectData(baseUrl + '/api/ProductosInstitucionales', 'txtProductoInstId', 'Select Producto Institucional'),
                loadSelectData(baseUrl + '/api/ProgramasPresupuestarios', 'txtProgramaPreId', 'Select Programa Presupuestario'),
                loadSelectData(baseUrl + '/api/Acciones', 'txtAccionId', 'Select Acción'),
                loadSelectData(baseUrl + '/api/Indicador', 'txtIndicadorId', 'Select Indicador')
            ])

            .finally(() => {
                formAgregar.style.display = 'block';
            });
        });

        const formAgregar = document.getElementById('formAgregar');
        const btnGuardarAgregar = document.getElementById('btnGuardarAgregar');

        function validateForm(form, submitBtn) {
            let valid = true;
            form.querySelectorAll('input[required], select[required], textarea[required]').forEach(input => {
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    valid = false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });
            if (submitBtn) submitBtn.disabled = !valid;
        }

        if (formAgregar && btnGuardarAgregar) {
            formAgregar.addEventListener('input', () => validateForm(formAgregar, btnGuardarAgregar));
        }

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('hidden.bs.modal', function () {
                this.querySelectorAll('input, select, textarea').forEach(input => {
                    input.value = '';
                    input.classList.remove('is-invalid');
                });
                if (btnGuardarAgregar) {
                    btnGuardarAgregar.disabled = true;
                }
            });
        });
    </script>
}

